<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spark IO</title>
  <meta name="author" content="Ben Chuanlong Du">

  <link href="http://www.legendu.net/misc/atom.xml" type="application/atom+xml" rel="alternate"
        title="Ben Chuanlong Du's Blog Atom Feed" />


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://www.legendu.net/misc/favicon.png" rel="icon">
  <link href="http://www.legendu.net/misc/theme/css/main_2.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://www.legendu.net/misc/theme/js/modernizr-2.0.js"></script>
  <script src="http://www.legendu.net/misc/theme/js/ender.js"></script>
  <script src="http://www.legendu.net/misc/theme/js/octopress.js" type="text/javascript"></script>

  <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://www.legendu.net/misc/">Ben Chuanlong Du's Blog</a></h1>
    <h2>It is never too late to learn.</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://www.legendu.net/misc/atom.xml" rel="subscribe-rss">RSS</a></li>
</ul>

<form name="search" action="https://www.bing.com/search" method="get" onSubmit="return build_query()">
  <fieldset role="search">
      <!--
    <input type="hidden" name="q" value="site:http://www.legendu.net/misc" />
        -->
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<script type = "text/javascript">
    function build_query() {
        var query = document.forms["search"]["q"].value;
        var prefix = "site:http://www.legendu.net/misc "
        if (!query.startsWith(prefix)) {
            query = prefix + query;
            document.forms["search"]["q"].value = query;
        }
        return true;
    }
</script>

<ul class="main-navigation">
    <li><a href="http://www.legendu.net">Home</a></li>
    <li><a href="http://www.legendu.net/misc">Blog</a></li>
    <li><a href="http://www.legendu.net/misc/archives.html">Archives</a></li>
    <li><a href="http://www.legendu.net/misc/pages/links.html">Links</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Spark IO</h1>
      <p class="meta"><time datetime="2019-07-08T23:28:03-07:00" pubdate>Jul 08, 2019</time></p>
</header>

  <div class="entry-content"><p><strong>
Things on this page are
fragmentary and immature notes/thoughts of the author.
It is not meant to readers
but rather for convenient reference of the author and future improvement.
</strong></p>
<ol>
<li>
<p>Do NOT read data from and write data to the same path in Spark!
  Due to lazy evaluation of Spark, 
  the path will likely be cleared before it's read into Spark,
  which will throw IO exceptions.
  And the worst part is that your data on HDFS is removed but recoverable.</p>
</li>
<li>
<p>When you want to keep headers in the data,
    it is suggested that you use the Parquet format to save data for multiple reasons.
    It is fast, takes less space
    and you don't have to worry about duplicated headers encountered when merging CSV files with headers.
    There is no need to merge Parquet files.
    You can directly read in a folder of Parquet files in all kinds of programming languages,
    which is more convenient than a folder of CSV files.</p>
</li>
<li>
<p>Writing to existing files using <code>RDD.saveAsTextFile</code> throws file already exist exception.
    This s because Hadoop filesystem does not overwrite files that already exist.
    <code>RDD.saveAsTextFile</code> does not provide an option to manually overwrite existing files.
    To avoid the issue,
    you have to manually remove the existing file before writing to them.
    Of course,
    it is no longer suggested to use RDD directly any more in Spark.
    You use should DataFrame as much as possible.
    <code>DataFrame.write</code> allows you to overwrite existing HDFS files via <code>DataFrame.write.option("overwrite")</code>.</p>
</li>
</ol>
<h2 id="readiness-of-data-on-hdfs">Readiness of Data on HDFS</h2>
<ol>
<li>Data in a Hive table guarantees completeness
    which means that if you see data of a certain date in the table,
    the complete data is there.
    However, if you work with other format (Parquet, Avro, Sequence, etc.),
    you'd better check for data readiness before you use it.
    A simple way to do this is to check whether the <code>_SUCESS</code> file exists in the same directory.</li>
</ol>
<h2 id="parquet">Parquet</h2>
<p>https://spark.apache.org/docs/latest/sql-data-sources-parquet.html#partition-discovery</p>
<ol>
<li>
<p>You have issues saving a DataFrame read in from Parquet to a CSV file.
    The reason is that Parquet support more complex data structures (e.g., array)
    which is not supported in CSV.</p>
</li>
<li>
<p>Shell-like syntax (curly brace, wildcard, etc.) of matching multiple files is supported in both the Scala API
    and the SQL API when querying files directly
    as long as it does cause CONFLICTING directory structure.</p>
<div class="highlight"><pre><span></span><span class="n">files</span> <span class="o">=</span> <span class="s1">&#39;s3a://dev/2017/01/{02,03}/data.parquet&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="k">session</span><span class="p">.</span><span class="k">read</span><span class="p">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

<span class="n">spark</span><span class="p">.</span><span class="k">read</span><span class="p">.</span><span class="n">parquet</span><span class="p">(</span><span class="ss">&quot;some_path/2019-02-10_05-38-11/SITE_NAME=*&quot;</span><span class="p">)</span>

<span class="k">select</span>
    <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">n</span>
<span class="k">from</span>
    <span class="n">parquet</span><span class="p">.</span><span class="o">`/</span><span class="n">some_path</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">10</span><span class="n">_05</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="mi">11</span><span class="o">/</span><span class="n">SITE_NAME</span><span class="o">=*`</span>
</pre></div>


</li>
</ol>
<p>https://spark.apache.org/docs/latest/sql-data-sources-parquet.html</p>
<p>https://docs.databricks.com/spark/latest/data-sources/read-parquet.html</p>
<h2 id="file-format">File Format</h2>
<p>avro offical support instead of databricks? simplest way to read avro into data frame?</p>
<p>– Text – Sequence – Avro – Parquet – ORC</p>
<p>Example orc file for me to read?</p>
<p>spark: it seems that we must know the schema of sequence files ...</p>
<h2 id="rddsaveastextfile">RDD.saveAsTextFile</h2>
<ol>
<li>
<p><code>RDD.saveAsTextFile</code> does not provide options to control the format of output files.
    You have to manually format the RDD to one containings string in the format that you want.
    For example,
    if rdd contains tuples and you want to output it into TSV files,
    you can format it first using the following code.</p>
<div class="highlight"><pre><span></span><span class="n">rdd</span><span class="p">.</span><span class="k">map</span> <span class="err">{</span> <span class="n">x</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">x</span><span class="p">.</span><span class="n">productIterator</span><span class="p">.</span><span class="n">mkString</span><span class="p">(</span><span class="ss">&quot;\t&quot;</span><span class="p">)</span> <span class="err">}</span>
</pre></div>


</li>
<li>
<p>It takes lots of for <code>hadoop fs -getmerge</code>
    to extract and merge large number of compressed files.
    So it is suggested that you turn off compression
    when saving results into text files (using <code>saveAsTextFile</code>)
    especially when there are huge number of partitions.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">hadoopConfiguration</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="s">&quot;mapred.output.compress&quot;</span><span class="o">,</span> <span class="s">&quot;false&quot;</span><span class="o">)</span>
</pre></div></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Ben Chuanlong Du</span>
  </span>
<time datetime="2019-07-08T23:28:03-07:00" pubdate>Jul 08, 2019</time>  <span class="categories">
    <a class="category" href="http://www.legendu.net/misc/tag/programming.html">programming</a>
    <a class="category" href="http://www.legendu.net/misc/tag/spark.html">Spark</a>
    <a class="category" href="http://www.legendu.net/misc/tag/io.html">IO</a>
    <a class="category" href="http://www.legendu.net/misc/tag/compression.html">compression</a>
  </span>
</p>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://www.legendu.net/misc/blog/python-tips/">Tips on Python</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/misc/blog/python-tips-and-traps/">Python Tips and Traps</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/misc/blog/exception-and-error-handling-in-python/">Exception and Error Handling in Python</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/misc/blog/ipython-tips/">Tips on IPython</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/misc/blog/tips-for-git-large-file-storage/">Tips for Git Large File Storage</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://www.legendu.net/misc/category/ai.html">AI</a></li>
        <li><a href="http://www.legendu.net/misc/category/career.html">Career</a></li>
        <li><a href="http://www.legendu.net/misc/category/cloud.html">Cloud</a></li>
        <li><a href="http://www.legendu.net/misc/category/database.html">Database</a></li>
        <li><a href="http://www.legendu.net/misc/category/encryption.html">Encryption</a></li>
        <li><a href="http://www.legendu.net/misc/category/english.html">English</a></li>
        <li><a href="http://www.legendu.net/misc/category/finance.html">Finance</a></li>
        <li><a href="http://www.legendu.net/misc/category/fun-problems.html">Fun Problems</a></li>
        <li><a href="http://www.legendu.net/misc/category/hardware.html">Hardware</a></li>
        <li><a href="http://www.legendu.net/misc/category/internet.html">Internet</a></li>
        <li><a href="http://www.legendu.net/misc/category/job.html">Job</a></li>
        <li><a href="http://www.legendu.net/misc/category/jupyterlab.html">JupyterLab</a></li>
        <li><a href="http://www.legendu.net/misc/category/language.html">Language</a></li>
        <li><a href="http://www.legendu.net/misc/category/life.html">Life</a></li>
        <li><a href="http://www.legendu.net/misc/category/links.html">Links</a></li>
        <li><a href="http://www.legendu.net/misc/category/linux.html">Linux</a></li>
        <li><a href="http://www.legendu.net/misc/category/machine-learning.html">Machine Learning</a></li>
        <li><a href="http://www.legendu.net/misc/category/macos.html">macOS</a></li>
        <li><a href="http://www.legendu.net/misc/category/network.html">Network</a></li>
        <li><a href="http://www.legendu.net/misc/category/os.html">OS</a></li>
        <li><a href="http://www.legendu.net/misc/category/people.html">People</a></li>
        <li><a href="http://www.legendu.net/misc/category/philosophy.html">Philosophy</a></li>
        <li><a href="http://www.legendu.net/misc/category/programming.html">Programming</a></li>
        <li><a href="http://www.legendu.net/misc/category/research.html">Research</a></li>
        <li><a href="http://www.legendu.net/misc/category/sheng-huo.html">生活</a></li>
        <li><a href="http://www.legendu.net/misc/category/si-suo.html">思索</a></li>
        <li><a href="http://www.legendu.net/misc/category/software.html">Software</a></li>
        <li><a href="http://www.legendu.net/misc/category/statistics.html">Statistics</a></li>
        <li><a href="http://www.legendu.net/misc/category/teleconference.html">Teleconference</a></li>
        <li><a href="http://www.legendu.net/misc/category/tools.html">Tools</a></li>
        <li><a href="http://www.legendu.net/misc/category/trading.html">Trading</a></li>
        <li><a href="http://www.legendu.net/misc/category/unix.html">Unix</a></li>
        <li><a href="http://www.legendu.net/misc/category/visualization.html">Visualization</a></li>
        <li><a href="http://www.legendu.net/misc/category/windows.html">Windows</a></li>
        <li><a href="http://www.legendu.net/misc/category/work.html">Work</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
  <p class="tagcloud">
  </p>
  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/dclong">@dclong</a> on GitHub
    <script type="text/javascript">
      $.domReady(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'http://www.legendu.net/misc/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'dclong',
              count: 3,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="http://www.legendu.net/misc/theme/js/github.js" type="text/javascript"> </script>
  </section>

    <section>
        <h1>Social</h2>
        <ul>
            <li><a href="https://www.linkedin.com/in/ben-chuanlong-du-1239b221/" target="_blank">LinkedIn</a></li>
            <li><a href="https://twitter.com/longendu" target="_blank">Twitter</a></li>
            <li><a href="https://www.facebook.com/chuanlong.du" target="_blank">Facebook</a></li>
        <!--
            <li><a href="http://www.legendu.net/misc/" type="application/rss+xml" rel="alternate">RSS</a></li>
            -->
        </ul>
    </section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Ben Chuanlong Du -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30259661-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
	<script type="text/javascript">
	  var disqus_shortname = 'dclong';
          var disqus_identifier = '/blog/spark-io/';
          var disqus_url = 'http://www.legendu.net/misc/blog/spark-io/';
          var disqus_title = 'Spark IO';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
</body>
</html>